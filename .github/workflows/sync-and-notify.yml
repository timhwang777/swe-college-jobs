name: Sync and Notify Upstream Repository

on:
  schedule:
    - cron: '0 14,2 * * *'  # Runs every day at midnight PT
  workflow_dispatch:  # Allows manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add upstream repository
        run: git remote add upstream https://github.com/speedyapply/swe-college-jobs.git

      - name: Fetch upstream changes
        run: git fetch upstream

      - name: Check for changes
        id: changes
        run: |
          git fetch upstream main
          if [ -n "$(git diff --name-only upstream/main | grep -vE '^.github/')" ]; then
            echo "changes"
          else
            echo "no changes"
          fi
        continue-on-error: true

      - name: Set Output Variable
        id: set_output
        run: |
          if [ -n "$(git diff --name-only upstream/main | grep -vE '^.github/')" ]; then
            echo "need merge"
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "no need to merge"
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Merge upstream changes
        if: steps.set_output.outputs.changes == 'true'
        run: |
          git merge upstream/main --allow-unrelated-histories --no-commit
        continue-on-error: true

      - name: Push changes to fork
        if: steps.set_output.outputs.changes == 'true'
        run: git push origin main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify via email
        #if: steps.set_output.outputs.changes == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: 'swe-college-jobs Repository Updated'
          to: 'job-boards@timhwang.net'
          from: 'timhwang777/swe-college-jobs'
          html_body: |
              <!DOCTYPE html>
              <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Repository Update Notification</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            background-color: #f8f9fa;
                            color: #343a40;
                            margin: 0;
                            padding: 20px;
                        }
                        .container {
                            background-color: #ffffff;
                            padding: 20px;
                            border-radius: 5px;
                            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
                            max-width: 600px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #007bff;
                        }
                        p {
                            line-height: 1.6;
                        }
                        a {
                            color: #007bff;
                            text-decoration: none;
                        }
                        a:hover {
                            text-decoration: underline;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h1>"swe-college-jobs" Update Notification</h1>
                        <p>Hello,</p>
                        <p>The upstream repository has been updated. Changes have been fetched and merged into your fork. Please go to the following link to review the updates:</p>
                        <p><a href="https://github.com/timhwang777/swe-college-jobs/tree/main">https://github.com/timhwang777/swe-college-jobs/tree/main</a></p>
                    </div>
                </body>
              </html>
